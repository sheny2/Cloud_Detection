---
title: "Project 2 Cloud Data Code Appendix"
author: "Yicheng Shen (Student ID: 2806571) & Yunhong Bao (Student ID: 2427527)"
date: "December 6, 2022"
header-includes: 
      - \usepackage{amsmath}
output: 
    pdf_document    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, eval = F, cache = TRUE, warning = F, message = F)
library(mosaic)
library(GGally)
library(caret)
library(ggfortify)
library(gridExtra)
library(MASS)
library(e1071)
library(class)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(out.width = "100%", fig.align = 'center')
```


## EDA 

*scale in regression*

```{r read data and give name}
image_1 <- read.table("image_data/imagem1.txt")
image_2 <- read.table("image_data/imagem2.txt")
image_3 <- read.table("image_data/imagem3.txt")
var_name <- c("Y_coord", "X_coord", "Cloud", "NDAI", "SD", "CORR", "DF","CF","BF","AF","AN")
colnames(image_1) = colnames(image_2) = colnames(image_3) <- var_name
image_1$Cloud <- factor(image_1$Cloud)
image_2$Cloud <- factor(image_2$Cloud)
image_3$Cloud <- factor(image_3$Cloud)
```

```{r summary and dim}
summary(image_1)
summary(image_2)
summary(image_3)
dim(image_1)
dim(image_2)
dim(image_3)
```

```{r}
any(apply(image_1, 2, is.na))
any(apply(image_2, 2, is.na))
any(apply(image_3, 2, is.na))
```


```{r feature boxplot}
# image_1 %>% 
# ggplot() + geom_boxplot(aes(x=Cloud, y=SD)) 

all_image <- rbind(image_1 %>% mutate(image = "1"), image_2 %>% mutate(image = "2"), image_3 %>% mutate(image = "3"))
 
all_image%>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=NDAI, color = image)) 

all_image %>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=SD, color = image)) 

all_image %>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=CORR, color = image)) 
```


```{r pairwise, message = F, warning = F}
image_1 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()

image_2 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()

image_3 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()
```


*Do a PCA on the angle *
```{r angle corr}
image_1 %>% dplyr::select(DF:AN) %>% 
  ggpairs()
image_2 %>% dplyr::select(DF:AN) %>% 
  ggpairs()
image_3 %>% dplyr::select(DF:AN) %>% 
  ggpairs()
```


```{r cloud map}
# library(sf)
# ggplot(data = world) +
#     geom_sf() +
#     geom_point(data = image_1, aes(x = X-coord, y = Y-coord), size = 4, 
#         shape = 23, fill = "darkred") +
#     coord_sf(xlim = c(-88, -78), ylim = c(0, 33), expand = FALSE)

Palette_1 <- c("gray","black", "white")

map_1 <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1)

map_2 <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size =  0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1) 

map_3 <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1)
# map_1
# map_2
# map_3
```

```{r arranged map, fig.width=12,fig.height=4}
grid.arrange(arrangeGrob(map_1 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map_2 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map_3 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         nrow = 1))
```


*Better map?*

```{r new map}
Palette_2 <- c("gray", "white")

map1 <- image_1 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)

map2 <- image_2 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)

map3 <- image_3 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)
# map1
# map2
# map3
```

```{r arrange map, fig.width=12,fig.height=4}
map_legend <- lemon::g_legend(map1 +  guides(colour = guide_legend(nrow = 1)))

grid.arrange(arrangeGrob(map1 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map2 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map3 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         nrow = 1),
             map_legend, nrow = 2, heights = c(10, 1))
```


```{r 1 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate")

SD_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate")

CORR_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 


grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```


```{r 2 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

SD_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

CORR_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```


```{r 3 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="black", high="white")

SD_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="black", high="white")

CORR_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="black", high="white")

grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```


```{r angle map}
image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = DF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 

image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 

image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = BF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 

image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = AF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 

image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = AN), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 
```


```{r, fig.width=12, fig.height=3}
hist_1 <- image_1 %>% 
  ggplot(aes(x = NDAI)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_2 <- image_2 %>% 
  ggplot(aes(x = NDAI)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_3 <- image_3 %>% 
  ggplot(aes(x = NDAI)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

grid.arrange(hist_1 + ggeasy::easy_center_title(),
             hist_2 + ggeasy::easy_center_title(),
             hist_3 + ggeasy::easy_center_title(),
             nrow = 1)

# +
#   scale_fill_manual(values = c("steelblue1", "hotpink1")) +
#   scale_color_manual(values = c("steelblue1", "hotpink1")) +
#   theme_bw()

hist_1 <- image_1 %>% 
  ggplot(aes(x = SD)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_2 <- image_2 %>% 
  ggplot(aes(x = SD)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_3 <- image_3 %>% 
  ggplot(aes(x = SD)) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

grid.arrange(hist_1 + ggeasy::easy_center_title(),
             hist_2 + ggeasy::easy_center_title(),
             hist_3 + ggeasy::easy_center_title(),
             nrow = 1)


hist_1 <- image_1 %>% 
  ggplot(aes(x = log(SD))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_2 <- image_2 %>% 
  ggplot(aes(x = log(SD))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_3 <- image_3 %>% 
  ggplot(aes(x = log(SD))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

grid.arrange(hist_1 + ggeasy::easy_center_title(),
             hist_2 + ggeasy::easy_center_title(),
             hist_3 + ggeasy::easy_center_title(),
             nrow = 1)



hist_1 <- image_1 %>% 
  ggplot(aes(x = (CORR))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_2 <- image_2 %>% 
  ggplot(aes(x = (CORR))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_3 <- image_3 %>% 
  ggplot(aes(x = (CORR))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

grid.arrange(hist_1 + ggeasy::easy_center_title(),
             hist_2 + ggeasy::easy_center_title(),
             hist_3 + ggeasy::easy_center_title(),
             nrow = 1)
```



```{r, fig.width=12, fig.height=3.5}
hist_1 <- image_1 %>% 
  ggplot(aes(x = (DF))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_2 <- image_2 %>% 
  ggplot(aes(x = (DF))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

hist_3 <- image_3 %>% 
  ggplot(aes(x = (DF))) +
  geom_density(aes(fill = Cloud, color = Cloud), alpha = 0.7) 

grid.arrange(hist_1 + ggeasy::easy_center_title(),
             hist_2 + ggeasy::easy_center_title(),
             hist_3 + ggeasy::easy_center_title(),
             nrow = 1)
```



## Data Preparation 

**Should we exclude zero???**

```{r}
set.seed(8848)
sample_index_1 <- sample(nrow(image_1), nrow(image_1)*0.8)
image_1_train <- image_1[sample_index_1,]
image_1_test <- image_1[-sample_index_1,]
sample_index_2 <- sample(nrow(image_2), nrow(image_2)*0.8)
image_2_train <- image_2[sample_index_2,]
image_2_test <- image_2[-sample_index_2,]
sample_index_3 <- sample(nrow(image_3), nrow(image_3)*0.8)
image_3_train <- image_3[sample_index_3,]
image_3_test <- image_3[-sample_index_3,]
```

```{r}
# summary(image_1_train[,1:2])
# quantile(image_1_train$X_coord, c(0.5))
# quantile(image_1_train$Y_coord, c(0.2, 0.4, 0.6, 0.8))
# 

seperate_fold <- function(train_data) {
 
fold_1 <- train_data %>% filter(X_coord < quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0)) <= Y_coord, Y_coord  < quantile(train_data$Y_coord, c(0.2)) )
fold_2 <- train_data %>% filter(X_coord < quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.2)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.4)) )
fold_3 <- train_data %>% filter(X_coord < quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.4)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.6)) )
fold_4 <- train_data %>% filter(X_coord < quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.6)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.8)) )
fold_5 <- train_data %>% filter(X_coord < quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.8)) <= Y_coord, Y_coord <= quantile(train_data$Y_coord, c(1.0)) )
fold_6 <- train_data %>% filter(X_coord >= quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.2)) )
fold_7 <- train_data %>% filter(X_coord >= quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.2)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.4)) )
fold_8 <- train_data %>% filter(X_coord >= quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.4)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.6)) )
fold_9 <- train_data %>% filter(X_coord >= quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.6)) <= Y_coord, Y_coord < quantile(train_data$Y_coord, c(0.8)) )
fold_10 <- train_data %>% filter(X_coord >= quantile(train_data$X_coord, c(0.5)), quantile(train_data$Y_coord, c(0.8)) <= Y_coord, Y_coord <= quantile(train_data$Y_coord, c(1)) )

return( rbind(fold_1 %>% mutate(fold = "1"),
      fold_2 %>% mutate(fold = "2"),
      fold_3 %>% mutate(fold = "3"),
      fold_4 %>% mutate(fold = "4"),
      fold_5 %>% mutate(fold = "5"),
      fold_6 %>% mutate(fold = "6"),
      fold_7 %>% mutate(fold = "7"),
      fold_8 %>% mutate(fold = "8"),
      fold_9 %>% mutate(fold = "9"),
      fold_10 %>% mutate(fold = "10")) ) 
}

image_1_CV <- seperate_fold(image_1_train)
image_2_CV <- seperate_fold(image_2_train)
image_3_CV <- seperate_fold(image_3_train)


image_1_CV %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = fold), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") + theme(legend.position="none")
image_2_CV %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = fold), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") + theme(legend.position="none")
image_3_CV %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = fold), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + theme(legend.position="none") 

table(image_1_CV$fold)

image_all_CV <- rbind(image_1_CV,image_2_CV,image_3_CV)

dim(image_all_CV)

table(image_all_CV$fold)
```


## Model Fitting & Validation

```{r}
image_1_train_binary <- image_1_train %>% filter(Cloud != 0) 
M1.glm <- glm(Cloud ~ NDAI + SD + CORR + DF + CF + BF + AF + AN , data = image_1_train, family = 'binomial')
summary(M1.glm)

prob <- predict(M1.glm, image_1_test %>% filter(Cloud != 0) , type="response")
logit.model_pred <- ifelse(prob > 0.5, 1, 0)
mean(logit.model_pred != (image_1_test %>% filter(Cloud != 0))$Cloud)
```


```{r}
LDA_model <-
  lda(Cloud ~ NDAI + SD + CORR,
    data = image_1_train
  )
mean(predict(LDA_model, image_1_test)$class != image_1_test$Cloud)
```


```{r}
QDA_model <-
  lda(Cloud ~ NDAI + SD + CORR,
    data = image_1_train
  )
mean(predict(QDA_model, image_1_test)$class != image_1_test$Cloud)
```


```{r}
naive_bayes <- naiveBayes(Cloud ~ NDAI + SD + CORR, 
                data=image_1_train)
mean(predict(naive_bayes, image_1_test) != image_1_test$Cloud)
```


## Testing


