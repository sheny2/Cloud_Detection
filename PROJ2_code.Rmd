---
title: "Project 2 Cloud Data Code Appendix"
author: "Yicheng Shen (Student ID: 2806571) & Yunhong Bao (Student ID: 2427527)"
date: "December 6, 2022"
header-includes: 
      - \usepackage{amsmath}
output: 
    pdf_document    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, eval = F, cache = TRUE, warning = F, message = F)
library(mosaic)
library(GGally)
library(caret)
library(ggfortify)
library(gridExtra)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(out.width = "100%", fig.align = 'center')
```


## EDA 

*scale in regression *

```{r read data and give name}
image_1 <- read.table("image_data/imagem1.txt")
image_2 <- read.table("image_data/imagem2.txt")
image_3 <- read.table("image_data/imagem3.txt")
var_name <- c("Y_coord", "X_coord", "Cloud", "NDAI", "SD", "CORR", "DF","CF","BF","AF","AN")
colnames(image_1) = colnames(image_2) = colnames(image_3) <- var_name
image_1$Cloud <- factor(image_1$Cloud)
image_2$Cloud <- factor(image_2$Cloud)
image_3$Cloud <- factor(image_3$Cloud)
```

```{r summary and dim}
summary(image_1)
summary(image_2)
summary(image_3)
dim(image_1)
dim(image_2)
dim(image_3)
```

```{r}
any(apply(image_1, 2, is.na))
any(apply(image_2, 2, is.na))
any(apply(image_3, 2, is.na))
```



```{r feature boxplot}
# image_1 %>% 
# ggplot() + geom_boxplot(aes(x=Cloud, y=SD)) 

all_image <- rbind(image_1 %>% mutate(image = "1"), image_2 %>% mutate(image = "2"), image_3 %>% mutate(image = "3"))
 
all_image%>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=NDAI, color = image)) 

all_image %>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=SD, color = image)) 

all_image %>% 
  ggplot() + geom_boxplot(aes(x=Cloud, y=CORR, color = image)) 
```


```{r pairwise, message = F, warning = F}
image_1 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()

image_2 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()

image_3 %>%
  select(Cloud, NDAI, SD, CORR) %>% ggpairs()
```


```{r cloud map}
# library(sf)
# ggplot(data = world) +
#     geom_sf() +
#     geom_point(data = image_1, aes(x = X-coord, y = Y-coord), size = 4, 
#         shape = 23, fill = "darkred") +
#     coord_sf(xlim = c(-88, -78), ylim = c(0, 33), expand = FALSE)

Palette_1 <- c("gray","black", "white")

map_1 <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1)

map_2 <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size =  0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1) 

map_3 <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_map() + theme(legend.position = "none") +
  labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_1)
# map_1
# map_2
# map_3
```

```{r arranged map, fig.width=12,fig.height=4}
grid.arrange(arrangeGrob(map_1 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map_2 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map_3 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         nrow = 1))
```


*Better map?*

```{r new map}
Palette_2 <- c("gray", "white")

map1 <- image_1 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)

map2 <- image_2 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)

map3 <- image_3 %>%
  filter(Cloud != 0) %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = Cloud), size = 0.5) +
  theme_dark() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") +
  scale_colour_manual(values = Palette_2)
# map1
# map2
# map3
```

```{r arrange map, fig.width=12,fig.height=4}
map_legend <- lemon::g_legend(map1 +  guides(colour = guide_legend(nrow = 1)))

grid.arrange(arrangeGrob(map1 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map2 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         map3 + ggeasy::easy_center_title() + theme(legend.position="none"),
                         nrow = 1),
             map_legend, nrow = 2, heights = c(10, 1))
```


```{r 1 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate")

SD_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate")

CORR_plot <- image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 


grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```


```{r 2 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

SD_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

CORR_plot <- image_2 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 2", x = "X Coordinate", y = "Y Coordinate") 

grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```

```{r 3 covariate, fig.width=12,fig.height=3.5}
NDAI_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = NDAI), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="black", high="white")

SD_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = SD), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="gray", high="black")

CORR_plot <- image_3 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CORR), size = 0.5) +
  theme_map() + labs(title = "Image 3", x = "X Coordinate", y = "Y Coordinate") + 
  scale_color_gradient(low="black", high="white")

grid.arrange(NDAI_plot + ggeasy::easy_center_title(),
             SD_plot + ggeasy::easy_center_title(),
             CORR_plot + ggeasy::easy_center_title(),
             nrow = 1)
```

```{r}
image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = DF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 

image_1 %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = CF), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 
```


## Data Preparation 

```{r}
set.seed(8848)
sample_index <- sample(nrow(image_1), nrow(image_1)*0.8)
image_1_train <- image_1[sample_index,]
image_1_test <- image_1[-sample_index,]
```

```{r}
# summary(image_1_train[,1:2])
# 
# quantile(image_1_train$Y_coord, c(0.2, 0.4, 0.6, 0.8))
# 
# quantile(image_1_train$X_coord, c(0.5))

image_1_folder_1 <- image_1_train %>% filter(X_coord < 218, quantile(image_1_train$Y_coord, c(0)) <= Y_coord, Y_coord  < quantile(image_1_train$Y_coord, c(0.2)) )
image_1_folder_2 <- image_1_train %>% filter(X_coord < 218, quantile(image_1_train$Y_coord, c(0.2)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.4)) )
image_1_folder_3 <- image_1_train %>% filter(X_coord < 218, quantile(image_1_train$Y_coord, c(0.4)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.6)) )
image_1_folder_4 <- image_1_train %>% filter(X_coord < 218, quantile(image_1_train$Y_coord, c(0.6)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.8)) )
image_1_folder_5 <- image_1_train %>% filter(X_coord < 218, quantile(image_1_train$Y_coord, c(0.8)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(1.0)) )
image_1_folder_6 <- image_1_train %>% filter(X_coord >= 218, quantile(image_1_train$Y_coord, c(0)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.2)) )
image_1_folder_7 <- image_1_train %>% filter(X_coord >= 218, quantile(image_1_train$Y_coord, c(0.2)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.4)) )
image_1_folder_8 <- image_1_train %>% filter(X_coord >= 218, quantile(image_1_train$Y_coord, c(0.4)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.6)) )
image_1_folder_9 <- image_1_train %>% filter(X_coord >= 218, quantile(image_1_train$Y_coord, c(0.6)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(0.8)) )
image_1_folder_10 <- image_1_train %>% filter(X_coord >= 218, quantile(image_1_train$Y_coord, c(0.8)) <= Y_coord, Y_coord < quantile(image_1_train$Y_coord, c(1)) )

image_1_CV <- rbind(image_1_folder_1 %>% mutate(folder = "1"),
      image_1_folder_2 %>% mutate(folder = "2"),
      image_1_folder_3 %>% mutate(folder = "3"),
      image_1_folder_4 %>% mutate(folder = "4"),
      image_1_folder_5 %>% mutate(folder = "5"),
      image_1_folder_6 %>% mutate(folder = "6"),
      image_1_folder_7 %>% mutate(folder = "7"),
      image_1_folder_8 %>% mutate(folder = "8"),
      image_1_folder_9 %>% mutate(folder = "9"),
      image_1_folder_10 %>% mutate(folder = "10"))

image_1_CV %>%
  ggplot() + geom_point(aes(x = X_coord, y = Y_coord, color = folder), size = 0.5) +
  theme_map() + labs(title = "Image 1", x = "X Coordinate", y = "Y Coordinate") 
```




## Model Fitting 

```{r}
M1.glm <- glm(Cloud ~ NDAI + SD + CORR + DF + CF + BF + AF + AN , data = image_1 %>% filter(Cloud != 0), family = 'binomial')
summary(M1.glm)
```


```{r}

```







